<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Mergington High — Actividades</title>
	<link rel="stylesheet" href="./styles.css" />
</head>
<body>
	<header class="site-header">
		<h1>Mergington High — Actividades Extracurriculares</h1>
		<p class="lead">Explora actividades y consulta quiénes ya están inscritos.</p>
	</header>

	<main>
		<section id="activities" class="grid">
			<!-- Las tarjetas se insertan aquí -->
		</section>
	</main>

	<footer class="site-footer">
		<small>API demo — Mergington High</small>
	</footer>

	<script>
		async function loadActivities() {
			const container = document.getElementById('activities');
			container.innerHTML = '<p class="loading">Cargando actividades…</p>';
			try {
				const res = await fetch('/activities');
				if (!res.ok) throw new Error('No se pudo cargar la lista');
				const activities = await res.json();
				container.innerHTML = '';
				// activities es un objeto con claves = nombre de actividad
				Object.entries(activities).forEach(([name, info]) => {
					const card = document.createElement('article');
					card.className = 'card';

					card.innerHTML = `
					<header class="card-header">
						<h2 class="activity-title">${escapeHtml(name)}</h2>
						<p class="schedule">${escapeHtml(info.schedule || '')}</p>
					</header>
					<div class="card-body">
						<p class="description">${escapeHtml(info.description || '')}</p>
						<section class="participants-section">
							<h3>Participantes (${(info.participants || []).length})</h3>
							${renderParticipantsList(info.participants || [], name)}
						</section>
					</div>
					`;
					container.appendChild(card);
				});
				if (!Object.keys(activities).length) {
					container.innerHTML = '<p class="empty">No hay actividades disponibles.</p>';
				}
			} catch (err) {
				container.innerHTML = `<p class="error">Error cargando actividades: ${escapeHtml(err.message)}</p>`;
			}
		}

		function renderParticipantsList(list, activityName) {
			if (!list.length) return '<p class="no-participants">Aún no hay participantes.</p>';
			const items = list.map(email => `
				<li data-email="${escapeHtml(email)}" data-activity="${escapeHtml(activityName)}">
					<span class="participant-name">${escapeHtml(email)}</span>
					<button class="delete-btn" type="button" title="Unregister" aria-label="Unregister ${escapeHtml(email)}">✕</button>
				</li>
			`).join('');
			return `<ul class="participants-list">${items}</ul>`;
		}

		// Pequeña función para evitar inyección en el DOM
		function escapeHtml(str) {
			return String(str)
				.replaceAll('&', '&amp;')
				.replaceAll('<', '&lt;')
				.replaceAll('>', '&gt;')
				.replaceAll('"', '&quot;')
				.replaceAll("'", '&#39;');
		}

		// Inicializa
		document.addEventListener('DOMContentLoaded', loadActivities);

		// Event delegation for delete buttons
		document.addEventListener('click', async (event) => {
			if (event.target.closest('.delete-btn')) {
				const listItem = event.target.closest('li');
				const email = listItem.getAttribute('data-email');
				const activityName = listItem.getAttribute('data-activity');
				
				try {
					const response = await fetch(
						`/activities/${encodeURIComponent(activityName)}/unregister?email=${encodeURIComponent(email)}`,
						{ method: 'POST' }
					);
					
					if (response.ok) {
						// Reload activities to show updated participant list
						loadActivities();
					} else {
						const error = await response.json();
						alert(`Error: ${error.detail || 'Could not unregister'}`);
					}
				} catch (err) {
					alert(`Error unregistering: ${err.message}`);
				}
			}
		});
	</script>
</body>
</html>
